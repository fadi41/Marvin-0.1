<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marvin Settings</title>
  <style>
    /* Root variables and base styles (same as index.html) */
    :root {
        --primary-color: #3a86ff;
        --secondary-color: #8338ec;
        --accent-color: #ff006e;
        --dark-color: #1a1a2e;
        --light-color: #f8f9fa;
        --danger-color: #dc3545;
        --success-color: #28a745;
        --transition: all 0.3s ease;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f0f2f5;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
        width: 100%;
    }
    main.container {
        padding-top: 1rem;
        padding-bottom: 1rem;
        flex-grow: 1;
    }
    /* Header styles (copied from index.html) */
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 50px;
    }
    .navbar .logo h1 {
        margin: 0;
        font-size: 1.75rem;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 0.5rem;
      margin: 0;
      padding: 0;
    }
    nav ul li {
        display: inline-block;
    }
    nav ul li a {
        color: white;
        text-decoration: none;
        padding: 0.6rem 1rem;
        border-radius: 5px;
        transition: var(--transition);
        display: block;
        font-weight: 500;
    }
    nav ul li a:hover,
    nav ul li.active a {
      background-color: rgba(255, 255, 255, 0.2);
    }
    /* Settings page specific styles */
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
    }
    .card h2 {
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
        font-size: 1.25rem;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
    }
    textarea, input[type="text"], input[type="number"], input[type="password"], select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    textarea {
        min-height: 200px;
        font-family: monospace;
        resize: vertical;
    }
    select {
        cursor: pointer;
    }
    button {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        margin-right: 10px;
        margin-bottom: 10px;
    }
    button.primary {
        background-color: var(--primary-color);
        color: white;
    }
    button.primary:hover {
        background-color: #2a6bd1;
    }
    button.secondary {
        background-color: var(--secondary-color);
        color: white;
    }
     button.secondary:hover {
        background-color: #6a2cb3;
    }
    button.danger {
        background-color: var(--danger-color);
        color: white;
    }
    button.danger:hover {
        background-color: #b82a37;
    }
    .status {
      padding: 10px;
      margin-top: 15px;
      border-radius: 5px;
      border-left-width: 5px;
      border-left-style: solid;
      font-size: 0.9em;
    }
    .status.success { background-color: #d4edda; border-color: var(--success-color); color: #155724; }
    .status.error { background-color: #f8d7da; border-color: var(--danger-color); color: #721c24; }
    .status.info { background-color: #e2e3e5; border-color: #6c757d; color: #383d41; }
    .button-group {
        margin-top: auto; /* Push button group to bottom of card */
        padding-top: 1rem; /* Add space above buttons */
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    h1 {
        color: var(--dark-color);
        margin-bottom: 1rem;
    }
    /* Footer styles (optional, if needed) */
    footer {
      text-align: center;
      padding: 1rem;
      background-color: var(--dark-color);
      color: white;
      margin-top: auto;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <!-- Add Header/Navbar -->
  <header class="container">
    <div class="navbar">
      <div class="logo">
        <h1>Marvin AI</h1>
      </div>
      <nav>
          <ul>
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="logs.html">Logs</a></li>
            <!-- Add 'active' class to Settings link -->
            <li class="active"><a href="settings.html">Settings</a></li>
            <li><a href="analytics.html">Analytics</a></li>
          </ul>
      </nav>
    </div>
  </header>

  <!-- Main Settings Content -->
  <main class="container">
     <h1>Marvin Settings</h1>

    <div class="control-panel">

      <!-- System Instructions Card -->
       <div class="card">
          <h2>System Instructions</h2>
          <label for="systemInstructions">Edit Marvin's core instructions:</label>
          <textarea id="systemInstructions" placeholder="Enter system instructions here..."></textarea>
          <div class="button-group">
            <button id="loadInstructionsBtn" class="secondary">Load from File</button>
            <button id="saveInstructionsBtn" class="primary">Save to File</button>
            <!-- Hidden file input -->
             <input type="file" id="instructionsFileInput" accept=".txt" style="display: none;" />
          </div>
          <div id="instructionsStatus" class="status info">Load or edit instructions.</div>
       </div>

      <!-- Configuration Settings Card -->
       <div class="card">
        <h2>API Configuration</h2>

        <!-- Model Selection Dropdown -->
        <label for="model-select">Select Model:</label>
        <select id="model-select">
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
            <!-- Add other models as needed -->
            <option value="custom">Custom URL</option>
        </select>

        <!-- API Key Input -->
        <label for="api-key">API Key:</label>
        <input type="password" id="api-key" placeholder="Enter your Gemini API key">

        <!-- Custom URL Input (conditionally shown) -->
        <div id="custom-url-section" style="display: none;">
             <label for="gemini-url">Custom API URL:</label>
             <input type="text" id="gemini-url" placeholder="Enter full API URL for the custom model">
        </div>

        <div class="button-group">
            <button id="saveConfigBtn" onclick="saveApiConfiguration()" class="primary">Save API Config</button>
        </div>
        <div id="configStatus" class="status info">API Configuration status.</div>
      </div>

    </div> <!-- End control-panel -->
  </main> <!-- End container -->

  <!-- Optional Footer -->
  <!-- <footer class="container">
       <p>Â© 2025 Marvin AI. All rights reserved.</p>
   </footer> -->

  <script>
    // DOM References
    const modelSelect = document.getElementById('model-select');
    const apiKeyInput = document.getElementById('api-key');
    const customUrlSection = document.getElementById('custom-url-section');
    const geminiUrlInput = document.getElementById('gemini-url'); // Custom URL input
    const configStatusDiv = document.getElementById('configStatus');
    const saveConfigBtn = document.getElementById('saveConfigBtn'); // Added ID to button
    
    const systemInstructionsTextarea = document.getElementById('systemInstructions');
    const instructionsFileInput = document.getElementById('instructionsFileInput');
    const loadInstructionsBtn = document.getElementById('loadInstructionsBtn');
    const saveInstructionsBtn = document.getElementById('saveInstructionsBtn');
    const instructionsStatusDiv = document.getElementById('instructionsStatus');

    // Predefined URLs for standard models
    const GEMINI_URLS = {
        'gemini-1.5-pro': 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent',
        'gemini-1.5-flash': 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
        'gemini-1.0-pro': 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.0-pro:generateContent',
        // Add others if needed
    };

    // --- Configuration Logic --- 
    
    // Show/hide custom URL input based on dropdown selection
    modelSelect.addEventListener('change', () => {
        if (modelSelect.value === 'custom') {
            customUrlSection.style.display = 'block';
            geminiUrlInput.placeholder = 'Enter full API URL (e.g., https://...)';
        } else {
            customUrlSection.style.display = 'none';
        }
    });

    function saveApiConfiguration() {
      saveConfigBtn.disabled = true; // Prevent double-clicks
      saveConfigBtn.textContent = 'Saving...';

      const selectedModel = modelSelect.value;
      let effectiveUrl = '';

      if (selectedModel === 'custom') {
          effectiveUrl = geminiUrlInput.value.trim();
          if (!effectiveUrl) {
              updateStatus(configStatusDiv, 'Custom API URL cannot be empty when selected.', 'error');
              enableSaveButton();
              return;
          }
          // Basic URL validation (optional but recommended)
          try {
              new URL(effectiveUrl);
          } catch (_) {
              updateStatus(configStatusDiv, 'Invalid Custom API URL format.', 'error');
              enableSaveButton();
              return;
          }
      } else {
          effectiveUrl = GEMINI_URLS[selectedModel];
          if (!effectiveUrl) {
               updateStatus(configStatusDiv, 'Invalid model selection.', 'error'); // Should not happen normally
               enableSaveButton();
               return;
          }
      }

      const config = {
        model: selectedModel, // Store the selected model key
        apiKey: apiKeyInput.value.trim(),
        // Store the URL actually used, whether predefined or custom
        apiUrl: effectiveUrl 
      };
      
      // API Key Validation
      if (!config.apiKey) {
          updateStatus(configStatusDiv, 'API Key cannot be empty.', 'error');
          enableSaveButton();
          return;
      }
      
      // Log the configuration being saved (excluding API key for security)
      console.log('Saving config:', { model: config.model, apiUrl: config.apiUrl });
      
      try {
          localStorage.setItem('marvin-api-config', JSON.stringify(config));
          updateStatus(configStatusDiv, 'API Configuration saved successfully.', 'success');
      } catch (e) {
           console.error("Error saving to localStorage:", e);
           updateStatus(configStatusDiv, 'Error saving configuration. LocalStorage might be full or disabled.', 'error');
      }
      enableSaveButton();
    }
    
    function enableSaveButton() {
        saveConfigBtn.disabled = false;
        saveConfigBtn.textContent = 'Save API Config';
    }

    function loadApiConfiguration() {
        const savedConfig = localStorage.getItem('marvin-api-config');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                console.log('Loading saved config:', config);
                
                apiKeyInput.value = config.apiKey || '';
                
                // Set the dropdown value
                if (config.model && modelSelect.querySelector(`option[value="${config.model}"]`)) {
                   modelSelect.value = config.model;
                } else if (config.apiUrl && !Object.values(GEMINI_URLS).includes(config.apiUrl)) {
                    // If the saved URL doesn't match a predefined one, assume it was custom
                    modelSelect.value = 'custom';
                    geminiUrlInput.value = config.apiUrl; 
                } else {
                    // Default to a standard model if saved model is invalid or missing
                    modelSelect.value = 'gemini-1.5-pro';
                }

                // Trigger change event to update UI (e.g., show/hide custom URL)
                modelSelect.dispatchEvent(new Event('change'));

                updateStatus(configStatusDiv, 'Loaded saved API configuration.', 'info');
            } catch (error) {
                 console.error("Error loading/parsing config:", error);
                 updateStatus(configStatusDiv, `Error loading API config: ${error.message}. Using defaults.`, 'error');
                 modelSelect.value = 'gemini-1.5-pro'; // Reset to default on error
                 modelSelect.dispatchEvent(new Event('change'));
            }
        } else {
             updateStatus(configStatusDiv, 'No saved API configuration found. Please select model and enter key.', 'info');
             modelSelect.value = 'gemini-1.5-pro'; // Default selection
             modelSelect.dispatchEvent(new Event('change'));
        }
    }

    // --- System Instructions --- 
    loadInstructionsBtn.addEventListener('click', () => instructionsFileInput.click());

    instructionsFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type === "text/plain") {
            const reader = new FileReader();
            reader.onload = (e) => {
                systemInstructionsTextarea.value = e.target.result;
                updateStatus(instructionsStatusDiv, `Loaded instructions from ${file.name}.`, 'success');
                instructionsFileInput.value = null; // Reset file input
            };
            reader.onerror = (e) => {
                updateStatus(instructionsStatusDiv, 'Error reading instructions file.', 'error');
                 instructionsFileInput.value = null;
            };
            reader.readAsText(file);
        } else if (file) {
            updateStatus(instructionsStatusDiv, 'Please select a valid .txt file.', 'error');
            instructionsFileInput.value = null;
        }
    });

    saveInstructionsBtn.addEventListener('click', () => {
        const instructionsText = systemInstructionsTextarea.value;
        if (instructionsText.trim() === '') {
            updateStatus(instructionsStatusDiv, 'Cannot save empty instructions.', 'error');
            return;
        }
        // Saves via browser download
        const blob = new Blob([instructionsText], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'marvin_system_instructions_v0.6.txt'; // Suggest a filename
        document.body.appendChild(link); // Required for Firefox
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href); // Clean up
        updateStatus(instructionsStatusDiv, 'Instructions prepared for download.', 'success');
    });

     // Helper function to update status divs
     function updateStatus(element, message, type = 'info') { // type can be 'info', 'success', 'error'
         element.textContent = message;
         element.className = `status ${type}`; // Reset classes and add new type
     }

    // --- Initialization --- 
    document.addEventListener('DOMContentLoaded', () => {
        loadApiConfiguration();
        updateStatus(instructionsStatusDiv, 'Load instructions from a file or edit directly.', 'info');
    });

  </script>
</body>
</html>
